// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ============================================
// 핵심 워크플로우: 키워드 → 스크래핑 → 요약 → 영상 생성
// ============================================

// 뉴스 소스 관리 (크롤링 대상)
model NewsSource {
  id             String    @id @default(cuid())
  name           String
  url            String    @unique
  type           String    @default("news")  // news, rss, social, blog
  category       String    @default("일반")
  description    String?
  headers        String?   // JSON string for custom headers
  enabled        Boolean   @default(true)
  status         String    @default("inactive") // active, inactive, error, pending
  itemsCollected Int       @default(0)
  successRate    Float     @default(0)
  lastCrawl      DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
}

// 수집된 기사
model Article {
  id             String        @id @default(cuid())
  title          String
  content        String
  url            String        @unique
  author         String?
  publishedAt    DateTime?
  extractedAt    DateTime      @default(now())
  imageUrl       String?
  sourceName     String        // 출처 이름
  sourceUrl      String        // 출처 URL
  relevanceScore Float?        // 키워드 관련도 점수 (0-100)
  keywordMatches String?       // JSON array: 매칭된 키워드들
  status         ArticleStatus @default(RAW)
  summaries      Summary[]
  videos         Video[]
  searchResults  SearchResult[]
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
}

enum ArticleStatus {
  RAW           // 원본 수집 상태
  PROCESSED     // 텍스트 정제 완료
  SUMMARIZED    // 요약 생성 완료
  FAILED        // 처리 실패
}

// AI 생성 요약
model Summary {
  id        String      @id @default(cuid())
  articleId String
  article   Article     @relation(fields: [articleId], references: [id], onDelete: Cascade)
  type      SummaryType @default(SHORT)
  content   String      // 요약 내용
  keywords  String?     // JSON array: 추출된 키워드
  sentiment String?     // positive, neutral, negative
  model     String      @default("gpt-4") // 사용한 AI 모델
  tokenUsage Int?       // 사용한 토큰 수
  videos    Video[]
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
}

enum SummaryType {
  SHORT         // 짧은 요약
  MEDIUM        // 중간 요약
  LONG          // 긴 요약
  BULLET_POINTS // 불릿 포인트
}

// 동영상 생성
model Video {
  id          String      @id @default(cuid())
  articleId   String?
  article     Article?    @relation(fields: [articleId], references: [id], onDelete: SetNull)
  summaryId   String?
  summary     Summary?    @relation(fields: [summaryId], references: [id], onDelete: SetNull)
  title       String
  description String?
  prompt      String      // 영상 생성 프롬프트

  // 영상 설정
  format      VideoFormat @default(VERTICAL)
  duration    Int         @default(60) // 초 단위
  resolution  String      @default("1080x1920")

  // 파일 정보
  filePath      String?   // 영상 파일 경로
  thumbnailPath String?   // 썸네일 경로
  fileSize      Int?      // 바이트 단위

  // 상태
  status       VideoStatus @default(PENDING)
  errorMessage String?
  progress     Int         @default(0) // 0-100

  // 통계
  views     Int @default(0)
  downloads Int @default(0)

  // 처리 로그
  processingLogs VideoProcessingLog[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum VideoStatus {
  PENDING      // 대기 중
  SCRAPING     // 스크래핑 중
  SUMMARIZING  // 요약 생성 중
  PROMPTING    // 프롬프트 생성 중
  GENERATING   // 영상 생성 중
  COMPLETED    // 완료
  FAILED       // 실패
}

enum VideoFormat {
  VERTICAL   // 9:16 (1080x1920) - 세로
  HORIZONTAL // 16:9 (1920x1080) - 가로
  SQUARE     // 1:1 (1080x1080) - 정사각형
}

// 동영상 템플릿
model VideoTemplate {
  id           String   @id @default(cuid())
  name         String
  description  String?
  format       VideoFormat
  prompt       String   // 기본 프롬프트 템플릿
  thumbnailUrl String?
  isActive     Boolean  @default(true)
  usageCount   Int      @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

// 동영상 처리 로그
model VideoProcessingLog {
  id        String   @id @default(cuid())
  videoId   String
  video     Video    @relation(fields: [videoId], references: [id], onDelete: Cascade)
  stage     String   // scraping, summarizing, prompting, generating, completed
  status    String   // started, completed, failed
  message   String?
  duration  Int?     // 밀리초
  createdAt DateTime @default(now())
}

// ============================================
// 검색 및 키워드 관리
// ============================================

// 키워드 관리
model Keyword {
  id            String          @id @default(cuid())
  keyword       String          @unique
  description   String?
  category      String?
  isFavorite    Boolean         @default(false)
  useCount      Int             @default(0)
  searchHistory SearchHistory[]
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
}

// 검색 기록
model SearchHistory {
  id            String         @id @default(cuid())
  keywordId     String?
  keyword       Keyword?       @relation(fields: [keywordId], references: [id], onDelete: SetNull)
  searchQuery   String         // 검색어
  resultCount   Int            @default(0)
  searchTime    Float?         // 검색 소요 시간 (초)
  filters       String?        // JSON: 사용된 필터
  status        SearchStatus   @default(COMPLETED)
  errorMessage  String?
  searchResults SearchResult[]
  createdAt     DateTime       @default(now())
}

enum SearchStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  FAILED
}

// 검색 결과 (검색과 기사의 연결)
model SearchResult {
  id              String        @id @default(cuid())
  searchHistoryId String
  searchHistory   SearchHistory @relation(fields: [searchHistoryId], references: [id], onDelete: Cascade)
  articleId       String
  article         Article       @relation(fields: [articleId], references: [id], onDelete: Cascade)
  relevanceScore  Float         @default(0)
  searchRank      Int           // 검색 결과 순위
  createdAt       DateTime      @default(now())

  @@unique([searchHistoryId, articleId])
}

// ============================================
// AI 사용량 추적
// ============================================

// AI API 사용량 로그
model AIUsageLog {
  id               String   @id @default(cuid())
  operation        String   // summary, keyword_extraction, video_prompt
  model            String   // gpt-4, gpt-3.5-turbo
  promptTokens     Int      @default(0)
  completionTokens Int      @default(0)
  totalTokens      Int      @default(0)
  cost             Float?   // 예상 비용 (USD)
  responseTime     Float?   // 응답 시간 (초)
  status           String   // success, error
  errorMessage     String?
  createdAt        DateTime @default(now())
}

// ============================================
// 워크플로우 관리
// ============================================

// 워크플로우 작업 (키워드 → 영상 생성까지의 전체 프로세스)
model Workflow {
  id           String         @id @default(cuid())
  keywords     String         // JSON array
  articleId    String?        // 선택된 기사 ID
  summaryId    String?        // 생성된 요약 ID
  videoId      String?        // 생성된 영상 ID
  status       WorkflowStatus @default(PENDING)
  currentStep  String?        // 현재 진행 단계
  progress     Int            @default(0) // 0-100
  errorMessage String?
  startedAt    DateTime?
  completedAt  DateTime?
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
}

enum WorkflowStatus {
  PENDING      // 대기 중
  SCRAPING     // 스크래핑 중
  SUMMARIZING  // 요약 중
  PROMPTING    // 프롬프트 생성 중
  GENERATING   // 영상 생성 중
  COMPLETED    // 완료
  FAILED       // 실패
}
